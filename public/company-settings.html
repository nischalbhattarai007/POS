<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Company Settings - POS System</title>
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <span style="font-weight: 600; color: var(--primary);">Menu</span>
        </div>
        <ul class="sidebar-menu">
            <li><a href="superadmin-dashboard.html">üè† Dashboard</a></li>
            <li><a href="superadmin-dashboard.html#invoices">üßæ Invoices</a></li>
            <li><a href="company-settings.html" class="active">‚öôÔ∏è Company Settings</a></li>
            <li><a href="user-management.html">üë• User Management</a></li>
            <li><a href="reports.html">üìä Reports</a></li>
        </ul>
    </div>
    
    <!-- Main Content -->
    <div class="main-content" id="mainContent">
        <!-- Mobile Header -->
        <div class="mobile-header">
            <button class="sidebar-toggle" onclick="toggleSidebar()">‚ò∞</button>
            <span style="font-weight: 600; color: var(--dark);">Company Settings</span>
        </div>
        
        <div class="company-header">
            <div class="company-brand">
                <div class="company-logo" id="companyLogoHeader">
                    <div class="company-logo-placeholder">üè™</div>
                </div>
                <div class="company-details">
                    <div class="company-name" id="companyNameHeader">POS System</div>
                </div>
            </div>
            <div class="user-info">
                <span class="user-badge" id="userName"></span>
                <span class="role-badge">SUPERADMIN</span>
                <button class="btn btn-secondary btn-sm" onclick="logout()">Logout</button>
            </div>
        </div>

        <div class="container">
        <div id="alert"></div>

        <div class="grid grid-2">
            <div class="card">
                <div class="card-header">Company Information</div>
                <form id="companyForm">
                    <div class="form-group">
                        <label>Company Name</label>
                        <input type="text" class="form-control" id="companyName" required>
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" class="form-control" id="companyEmail" required>
                    </div>
                    <div class="form-group">
                        <label>Phone</label>
                        <input type="tel" class="form-control" id="companyPhone" required>
                    </div>
                    <div class="form-group">
                        <label>PAN Number</label>
                        <input type="text" class="form-control" id="panNumber" placeholder="e.g., ABCDE1234F" maxlength="10" style="text-transform: uppercase;" required>
                        <small style="color: #6b7280; font-size: 12px;">Enter 10-character PAN number</small>
                    </div>
                    <div class="form-group">
                        <label>Address</label>
                        <textarea class="form-control" id="companyAddress" rows="3" required></textarea>
                    </div>
                    <div class="form-group">
                        <label>Tax Rate (%)</label>
                        <input type="number" class="form-control" id="taxRate" min="0" max="100" step="0.01" placeholder="e.g., 10 for 10%" required>
                        <small style="color: #6b7280; font-size: 12px;">Enter tax percentage (e.g., 10 for 10%)</small>
                    </div>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </form>
            </div>

            <div>
                <div class="card">
                    <div class="card-header">Company Logo</div>
                    <div class="logo-preview" id="logoPreview">
                        <span style="color: #9ca3af;">No logo uploaded</span>
                    </div>
                    <input type="file" id="logoInput" accept="image/*" style="display: none;">
                    <div style="display: flex; gap: 8px; margin-top: 12px;">
                        <button class="btn btn-primary" style="flex: 1;" onclick="document.getElementById('logoInput').click()">
                            Upload Logo
                        </button>
                        <button class="btn btn-danger" id="removeLogo" style="flex: 1; display: none;" onclick="removeLogo()">
                            Remove Logo
                        </button>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">Change Password</div>
                    <form id="passwordForm">
                        <div class="form-group">
                            <label>Current Password</label>
                            <input type="password" class="form-control" id="currentPassword" required>
                        </div>
                        <div class="form-group">
                            <label>New Password</label>
                            <input type="password" class="form-control" id="newPassword" minlength="6" required>
                        </div>
                        <div class="form-group">
                            <label>Confirm New Password</label>
                            <input type="password" class="form-control" id="confirmPassword" minlength="6" required>
                        </div>
                        <button type="submit" class="btn btn-primary w-full">Update Password</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    </div>

    <script src="js/config.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/api.js"></script>
    <script src="js/auth.js"></script>
    <script>
        checkAuth(CONFIG.ROLES.SUPERADMIN);
        
        const user = getUser();
        document.getElementById('userName').textContent = user?.username || 'Super Admin';

        async function loadSettings() {
            try {
                const response = await api.getCompanySettings();
                const settings = response.data;
                
                document.getElementById('companyName').value = settings.companyName || '';
                document.getElementById('companyEmail').value = settings.email || '';
                document.getElementById('companyPhone').value = settings.contact || '';
                document.getElementById('panNumber').value = settings.panNumber || '';
                document.getElementById('companyAddress').value = settings.address || '';
                document.getElementById('taxRate').value = settings.taxRate || 10;
                
                if (settings.logo) {
                    showLogoPreview(settings.logo);
                }
            } catch (error) {
                console.log('Settings not found, using defaults');
            }
        }

        document.getElementById('companyForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const settings = {
                companyName: document.getElementById('companyName').value.trim(),
                email: document.getElementById('companyEmail').value.trim(),
                contact: document.getElementById('companyPhone').value.trim(),
                panNumber: document.getElementById('panNumber').value.trim().toUpperCase(),
                address: document.getElementById('companyAddress').value.trim(),
                taxRate: parseFloat(document.getElementById('taxRate').value) || 10
            };

            try {
                await api.updateCompanySettings(settings);
                utils.showAlert('Company settings updated successfully!', 'success');
            } catch (error) {
                utils.showAlert(error.message, 'error');
            }
        });

        document.getElementById('logoInput').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            if (!file.type.startsWith('image/')) {
                utils.showAlert('Please select an image file', 'error');
                return;
            }

            if (file.size > 2 * 1024 * 1024) {
                utils.showAlert('Image size should be less than 2MB', 'error');
                return;
            }

            const formData = new FormData();
            formData.append('logo', file);

            try {
                const response = await api.uploadLogo(formData);
                const logoPath = response.data.logo || response.data.logoPath;
                if (logoPath) {
                    showLogoPreview(logoPath);
                }
                utils.showAlert('Logo uploaded successfully!', 'success');
            } catch (error) {
                utils.showAlert(error.message, 'error');
            }
        });

        document.getElementById('passwordForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            if (newPassword !== confirmPassword) {
                utils.showAlert('New passwords do not match', 'error');
                return;
            }

            if (newPassword.length < 6) {
                utils.showAlert('Password must be at least 6 characters', 'error');
                return;
            }

            try {
                await api.changePassword(currentPassword, newPassword);
                utils.showAlert('Password changed successfully!', 'success');
                e.target.reset();
            } catch (error) {
                utils.showAlert(error.message, 'error');
            }
        });

        function showLogoPreview(logoPath) {
            const imgSrc = logoPath.startsWith('http') ? logoPath : `${CONFIG.API_URL.replace('/api', '')}/${logoPath}`;
            console.log('Logo path:', logoPath);
            console.log('Image src:', imgSrc);
            document.getElementById('logoPreview').innerHTML = `<img src="${imgSrc}" alt="Company Logo" style="max-width: 100%; max-height: 100%; object-fit: contain;">`;
            document.getElementById('removeLogo').style.display = 'block';
        }

        async function removeLogo() {
            if (!confirm('Are you sure you want to remove the logo?')) return;

            try {
                await api.updateCompanySettings({ logo: null });
                document.getElementById('logoPreview').innerHTML = '<span style="color: #9ca3af;">No logo uploaded</span>';
                document.getElementById('removeLogo').style.display = 'none';
                utils.showAlert('Logo removed successfully!', 'success');
            } catch (error) {
                utils.showAlert(error.message, 'error');
            }
        }

        loadSettings();
        
        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('show');
        }
    </script>
</body>
</html>
