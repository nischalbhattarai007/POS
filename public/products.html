<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Products - POS System</title>
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <span style="font-weight: 600; color: var(--primary);">Menu</span>
        </div>
        <ul class="sidebar-menu">
            <li><a href="dashboard.html">üè† Dashboard</a></li>
            <li><a href="products.html" class="active">üì¶ Products</a></li>
            <li><a href="categories.html">üìÅ Categories</a></li>
            <li><a href="billing.html">üõí Billing</a></li>
            <li><a href="invoices.html">üßæ Invoices</a></li>
        </ul>
    </div>
    
    <!-- Main Content -->
    <div class="main-content" id="mainContent">
        <!-- Mobile Header -->
        <div class="mobile-header">
            <button class="sidebar-toggle" onclick="toggleSidebar()">‚ò∞</button>
            <span style="font-weight: 600; color: var(--dark);">Products</span>
        </div>
        
        <div class="company-header">
        <div class="company-brand">
            <div class="company-logo" id="companyLogo">
                <div class="company-logo-placeholder">üè™</div>
            </div>
            <div class="company-details">
                <div class="company-name" id="companyName">POS System</div>
                <div class="company-info">
                    <span class="company-info-item" id="companyAddress"></span>
                    <span class="company-info-item" id="companyContact"></span>
                    <span class="company-info-item" id="companyEmail"></span>
                </div>
            </div>
        </div>
        <div class="user-info">
            <span class="user-badge" id="userName"></span>
            <span class="role-badge">ADMIN</span>
            <button class="btn btn-secondary btn-sm" onclick="logout()">Logout</button>
        </div>
        </div>

        <div class="container">
        <div class="card">
            <div class="card-header">
                <span>Products Management</span>
                <button class="btn btn-primary btn-sm" onclick="openModal()">Add Product</button>
            </div>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Image</th>
                            <th>Name</th>
                            <th>SKU</th>
                            <th>Price</th>
                            <th>Stock</th>
                            <th>Category</th>
                            <th>Barcode</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="productsTable">
                        <tr><td colspan="6" class="text-center">Loading...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="productModal" class="modal">
        <div class="modal-content">
            <div class="modal-header" id="modalHeader">Add Product</div>
            <form id="productForm">
                <div class="form-group">
                    <label>Product Name</label>
                    <input type="text" class="form-control" id="name" required>
                </div>
                <div class="form-group">
                    <label>SKU</label>
                    <input type="text" class="form-control" id="sku" required>
                </div>
                <div class="form-group">
                    <label>Barcode</label>
                    <input type="text" class="form-control" id="barcode" placeholder="Scan or enter barcode">
                    <small style="color: #666;">Optional - Use barcode scanner or enter manually</small>
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea class="form-control" id="description" rows="3"></textarea>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Price</label>
                        <input type="number" step="0.01" min="0" class="form-control" id="price" required>
                    </div>
                    <div class="form-group">
                        <label>Stock</label>
                        <input type="number" min="0" class="form-control" id="stock" required>
                    </div>
                </div>
                <div class="form-group">
                    <label>Category</label>
                    <select class="form-control" id="categoryId">
                        <option value="">Select Category</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Product Image</label>
                    <input type="file" class="form-control" id="productImage" accept="image/*">
                    <small style="color: #666;">Max 5MB (JPG, PNG, GIF, WEBP)</small>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Product</button>
                </div>
            </form>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    <script src="js/config.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/api.js"></script>
    <script src="js/auth.js"></script>
    <script>
        checkAuth(CONFIG.ROLES.ADMIN);
        
        const user = getUser();
        document.getElementById('userName').textContent = user?.username || 'Admin';
        
        async function loadCompanyInfo() {
            try {
                const response = await api.getCompanySettings();
                const company = response.data;
                
                document.getElementById('companyName').textContent = company.companyName || 'POS System';
                
                if (company.logo) {
                    document.getElementById('companyLogo').innerHTML = `<img src="http://localhost:5000/${company.logo}" alt="Logo">`;
                }
                
                if (company.address) {
                    document.getElementById('companyAddress').innerHTML = `üìç ${utils.sanitize(company.address)}`;
                }
                
                if (company.contact) {
                    document.getElementById('companyContact').innerHTML = `üìû ${utils.sanitize(company.contact)}`;
                }
                
                if (company.email) {
                    document.getElementById('companyEmail').innerHTML = `‚úâÔ∏è ${utils.sanitize(company.email)}`;
                }
            } catch (error) {
                console.log('Using default company info');
            }
        }
        
        loadCompanyInfo();

        async function loadProducts() {
            try {
                const response = await api.getProducts();
                const tbody = document.getElementById('productsTable');
                
                if (response.data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="8" class="text-center">No products found</td></tr>';
                    return;
                }
                
                tbody.innerHTML = response.data.map(p => `
                    <tr>
                        <td>
                            ${p.image ? 
                                `<img src="http://localhost:5000/${p.image}" style="width:50px;height:50px;object-fit:cover;border-radius:5px;" alt="${utils.sanitize(p.name)}">` : 
                                '<div style="width:50px;height:50px;background:#ddd;border-radius:5px;display:flex;align-items:center;justify-content:center;">üì¶</div>'
                            }
                        </td>
                        <td>${utils.sanitize(p.name)}</td>
                        <td>${utils.sanitize(p.sku)}</td>
                        <td>${utils.formatCurrency(p.price)}</td>
                        <td><span style="color: ${p.stock < 20 ? '#ef4444' : '#10b981'}">${p.stock}</span></td>
                        <td>${p.category?.name ? utils.sanitize(p.category.name) : p.Category?.name ? utils.sanitize(p.Category.name) : 'N/A'}</td>
                        <td>${p.barcode ? `<svg id="barcode-${p.id}"></svg>` : '-'}</td>
                        <td>
                            <button class="btn btn-primary btn-sm" onclick="editProduct(${p.id})" style="margin-right: 8px;">Edit</button>
                            <button class="btn btn-danger btn-sm" onclick="deleteProduct(${p.id})">Delete</button>
                        </td>
                    </tr>
                `).join('');
                
                // Generate barcodes
                response.data.forEach(p => {
                    if (p.barcode) {
                        try {
                            JsBarcode(`#barcode-${p.id}`, p.barcode, {
                                format: "CODE128",
                                width: 1,
                                height: 30,
                                displayValue: true,
                                fontSize: 10
                            });
                        } catch (e) {
                            document.getElementById(`barcode-${p.id}`).outerHTML = utils.sanitize(p.barcode);
                        }
                    }
                });
            } catch (error) {
                utils.showToast('Error loading products: ' + error.message, 'error');
            }
        }

        async function loadCategories() {
            try {
                const response = await api.getCategories();
                const select = document.getElementById('categoryId');
                select.innerHTML = '<option value="">Select Category</option>' + 
                    response.data.map(c => `<option value="${c.id}">${utils.sanitize(c.name)}</option>`).join('');
            } catch (error) {
                console.error('Error loading categories:', error);
            }
        }

        let editingProductId = null;

        function openModal() {
            editingProductId = null;
            document.getElementById('modalHeader').textContent = 'Add Product';
            document.getElementById('productModal').classList.add('active');
            document.getElementById('productForm').reset();
            loadCategories();
        }

        function closeModal() {
            editingProductId = null;
            document.getElementById('productModal').classList.remove('active');
            document.getElementById('productForm').reset();
        }

        async function editProduct(id) {
            try {
                const response = await api.request(`/products/${id}`);
                const product = response.data;
                
                editingProductId = id;
                document.getElementById('modalHeader').textContent = 'Edit Product';
                document.getElementById('name').value = product.name;
                document.getElementById('sku').value = product.sku;
                document.getElementById('barcode').value = product.barcode || '';
                document.getElementById('description').value = product.description || '';
                document.getElementById('price').value = product.price;
                document.getElementById('stock').value = product.stock;
                document.getElementById('categoryId').value = product.categoryId || '';
                
                document.getElementById('productModal').classList.add('active');
                await loadCategories();
                document.getElementById('categoryId').value = product.categoryId || '';
            } catch (error) {
                utils.showToast('Error loading product: ' + error.message, 'error');
            }
        }

        document.getElementById('productForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData();
            formData.append('name', document.getElementById('name').value.trim());
            formData.append('sku', document.getElementById('sku').value.trim());
            formData.append('barcode', document.getElementById('barcode').value.trim());
            formData.append('description', document.getElementById('description').value.trim());
            formData.append('price', document.getElementById('price').value);
            formData.append('stock', document.getElementById('stock').value);
            formData.append('categoryId', document.getElementById('categoryId').value || '');
            
            const imageFile = document.getElementById('productImage').files[0];
            if (imageFile) {
                formData.append('image', imageFile);
            }

            try {
                if (editingProductId) {
                    await api.updateProduct(editingProductId, formData);
                    utils.showToast('Product updated successfully!', 'success');
                } else {
                    await api.createProduct(formData);
                    utils.showToast('Product created successfully!', 'success');
                }
                closeModal();
                loadProducts();
            } catch (error) {
                utils.showToast(error.message, 'error');
            }
        });

        async function deleteProduct(id) {
            utils.confirm('Are you sure you want to delete this product?', async () => {
                try {
                    await api.deleteProduct(id);
                    utils.showToast('Product deleted successfully!', 'success');
                    loadProducts();
                } catch (error) {
                    utils.showToast(error.message, 'error');
                }
            });
        }

        loadProducts();
        
        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('show');
        }
    </script>
</body>
</html>
